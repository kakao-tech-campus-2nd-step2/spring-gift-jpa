<!DOCTYPE html>
<div th:replace="layout :: header"></div>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h2>Manage Products</h2>
        <div>
            <button class="btn btn-danger" id="deleteSelected">Delete</button>
            <button class="btn btn-success" id="addProduct">Add New Product</button>
        </div>
    </div>
    <!-- Search Box -->
    <div class="row mb-3">
        <div class="col-md-8">
            <input type="text" class="form-control" id="searchProductId" placeholder="Product ID ì…ë ¥">
        </div>
        <div class="col-md-4">
            <button class="btn btn-primary btn-block" id="searchProduct">Search</button>
        </div>
    </div>
    <!-- Products Table -->
    <table class="table table-striped">
        <!-- table header -->
        <thead class="thead-dark">
        <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Name</th>
            <th>Price</th>
            <th>Image URL</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="productTableBody">
        </tbody>
    </table>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- form ì„ í†µí•´ POST, PUT api ìš”ì²­ì„ ë³´ë‚¸ë‹¤ -->
                <form id="productForm">
                    <input type="hidden" id="productId" name="id">
                    <div class="form-group">
                        <label for="productName">Name</label>
                        <input type="text" class="form-control" id="productName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Price</label>
                        <input type="number" class="form-control" id="productPrice" name="price" required>
                    </div>
                    <div class="form-group">
                        <label for="productImageUrl">Image URL</label>
                        <input type="text" class="form-control" id="productImageUrl" name="imageUrl" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveProduct">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // API ì—”ë“œí¬ì¸íŠ¸ ê¸°ë³¸ URL
        const apiBaseUrl = '/api/products';

        // ì œí’ˆ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ì„œ í…Œì´ë¸”ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function loadProducts() {
            $.get(apiBaseUrl, function (response) {
                // í…Œì´ë¸” ë³¸ë¬¸ì„ ë¹„ìš°ê¸°
                $('#productTableBody').empty();

                // products ë°ì´í„°ë¡œ í…Œì´ë¸” í–‰ ìƒì„±
                response.data.forEach(product => {
                    $('#productTableBody').append(`
                        <tr data-id="${product.id}">
                            <td><input type="checkbox" class="productCheckbox"></td>
                            <td>${product.name}</td>
                            <td>${product.price}</td>
                            <td>${product.imageUrl}</td>
                            <td>
                                <button class="btn btn-warning btn-sm editProduct">âœï¸</button>
                                <button class="btn btn-danger btn-sm deleteProduct">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        // "Add New Product" ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì„ ì—´ê³  í¼ ì´ˆê¸°í™”
        $('#addProduct').click(function () {
            $('#productModalLabel').text('Add New Product');
            $('#productForm')[0].reset();
            $('#productId').val('');
            $('#productModal').modal('show');
        });

        // "Save changes" ë²„íŠ¼ í´ë¦­ ì‹œ í¼ ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ì €ì¥
        $('#saveProduct').click(function () {
            const productData = {
                name: $('#productName').val(),
                price: $('#productPrice').val(),
                imageUrl: $('#productImageUrl').val()
            };
            const productId = $('#productId').val();

            // POST ìš”ì²­ìœ¼ë¡œ Setting
            const ajaxOptions = {
                url: apiBaseUrl,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(productData),
                success: function () {
                    $('#productModal').modal('hide');
                    loadProducts();
                },
                error: function (xhr) {
                    if (xhr.status >= 400 && xhr.status < 500) {
                        alert(xhr.responseJSON.message);
                    }
                }
            };

            // ë§Œì•½ productId ê°’ì´ í• ë‹¹ë˜ì–´ ìˆìœ¼ë©´, í•´ë‹¹ ë°ì´í„° ìˆ˜ì • ìš”ì²­ì´ë‹¤
            // ë•Œë¬¸ì—, PUT ìœ¼ë¡œ ìš”ì²­ì„ ë°”ê¾¼ë‹¤
            if (productId) {
                ajaxOptions.url = apiBaseUrl + '/' + productId;
                ajaxOptions.type = 'PUT';
            }

            $.ajax(ajaxOptions);
        });

        // "Edit" ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ì œí’ˆ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ëª¨ë‹¬ì— í‘œì‹œ
        $(document).on('click', '.editProduct', function () {
            // $(this)ëŠ” jQuery ì„ íƒìë¡œ, í˜„ì¬ ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìš”ì†Œë¥¼ ì„ íƒ
            // .closest('tr')ëŠ” ì„ íƒëœ ìš”ì†Œ(this)ë¶€í„° ì‹œì‘í•˜ì—¬ ê°€ì¥ ê°€ê¹Œìš´ tr (í…Œì´ë¸” í–‰) ìš”ì†Œë¥¼ ì°¾ëŠ”ë‹¤
            // .data('id')ëŠ” ì„ íƒëœ ìš”ì†Œì˜ data-id ì†ì„± ê°’ì„ ê°€ì ¸ì˜¨ë‹¤
            const productId = $(this).closest('tr').data('id');
            $.get(apiBaseUrl + '/' + productId, function (response) {
                $('#productModalLabel').text('Edit Product');
                $('#productId').val(response.data.id);
                $('#productName').val(response.data.name);
                $('#productPrice').val(response.data.price);
                $('#productImageUrl').val(response.data.imageUrl);
                $('#productModal').modal('show');
            });
        });

        // "Delete" ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ì œí’ˆ ì‚­ì œ
        $(document).on('click', '.deleteProduct', function () {
            const productId = $(this).closest('tr').data('id');
            $.ajax({
                url: apiBaseUrl + '/' + productId,
                type: 'DELETE',
                success: function () {
                    loadProducts();
                }
            });
        });

        // ì„ íƒëœ ëª¨ë“  ì œí’ˆ ì¼ê´„ ì‚­ì œ
        $('#deleteSelected').click(function () {
            $('.productCheckbox:checked').each(function () {
                const productId = $(this).closest('tr').data('id');
                $.ajax({
                    url: apiBaseUrl + '/' + productId,
                    type: 'DELETE',
                    success: function () {
                        loadProducts();
                    }
                });
            });
        });

        // "Select All" ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ ëª¨ë“  ì œí’ˆ ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒ ë˜ëŠ” í•´ì œ
        $('#selectAll').click(function () {
            $('.productCheckbox').prop('checked', this.checked);
        });

        // ì œí’ˆ IDë¡œ ê²€ìƒ‰
        $('#searchProduct').click(function () {
            const productId = $('#searchProductId').val();
            if (productId) {
                $.ajax({
                    url: apiBaseUrl + '/' + productId,
                    type: 'GET',
                    success: function (response) {
                        // ê²€ìƒ‰ ê²°ê³¼ë¥¼ í…Œì´ë¸” ë³¸ë¬¸ì— í‘œì‹œ
                        const $productTableBody = $('#productTableBody');
                        $productTableBody.empty();
                        const product = response.data;
                        $productTableBody.append(`
                            <tr data-id="${product.id}">
                                <td><input type="checkbox" class="productCheckbox"></td>
                                <td>${product.name}</td>
                                <td>${product.price}</td>
                                <td>${product.imageUrl}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm editProduct">âœï¸</button>
                                    <button class="btn btn-danger btn-sm deleteProduct">ğŸ—‘ï¸</button>
                                </td>
                            </tr>
                        `);
                    },
                    // 'xhr'ì€ XMLHttpRequest ê°ì²´ë¡œ ìš”ì²­ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ë¥¼ ì €ì¥í•œë‹¤
                    //
                    error: function (xhr) {
                        // response ì— json ê°’ì´ ìˆëŠ” ì§€ í™•ì¸í•˜ê³ , error codeë¥¼ í™•ì¸í•œë‹¤
                        if (xhr.responseJSON && xhr.responseJSON.code === 'EP001') {
                            alert(xhr.responseJSON.message);
                            return
                        }
                        alert('An error occurred while fetching the product.');
                    }
                });
            }
            if (!productId) {
                // ê²€ìƒ‰ í•„ë“œê°€ ë¹„ì–´ ìˆì„ ë•Œ ì „ì²´ ì œí’ˆ ëª©ë¡ì„ ë¡œë“œ
                loadProducts();
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì œí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸°
        loadProducts();
    });
</script>
</body>
</html>
