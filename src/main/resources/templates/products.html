<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      margin:0;
      padding: 0;
    }
    #content {
      width: 700px;
      position: absolute;
      left: 50%;
      top: 50%;
      margin-left: -350px;
      margin-top: -250px;
      background-color: #EEEDEB;
      padding: 20px;
      border-radius: 5%;
    }
    #tableBox {
      height: 500px;
      overflow: scroll;
    }
    #header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    img {
      width: 100px;
    }
    th {
      width: 200px;
      text-align: center;
    }
    button {
      margin: 0;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 400;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      width: auto;
      border: none;
      border-radius: 4px;
      background: aqua;
      cursor: pointer;
    }
    .editBtn {
      background: #419DD9;
    }
    .removeBtn {
      background: #F05650;
    }
    #pagination button {
      margin: 5px;
    }
    .active {
      font-weight: bold;
      text-decoration: underline;
    }
  </style>
</head>
<body>
<div id="content">
  <div id="header">
    <h1>상품 리스트</h1>
    <a href="/products/new"><button>새로운 상품 생성</button></a>
  </div>
  <div id="tableBox">
    <table border="1">
      <thead>
      <tr>
        <th>ID</th>
        <th>이름</th>
        <th>가격</th>
        <th>이미지</th>
        <th colspan="2"></th>
      </tr>
      </thead>
      <tbody id="tableBody">
      </tbody>
    </table>
  </div>
  <div id="pagination"></div>
</div>
<script>
  function deleteProduct(id, currentPage) {
    fetch(`/api/products/${id}`, { method: 'DELETE' })
    .then(response => {
      if (response.ok) {
        fetchProducts(currentPage); // 삭제시 현재 페이지를 갱신
      } else {
        alert("상품 삭제 실행 중 오류 발생");
      }
    })
    .catch(error => console.error('Error:', error)); // 에러 핸들링 추가
  }

  document.addEventListener("DOMContentLoaded", function() {
    const tableBody = document.getElementById("tableBody");
    const pagination = document.getElementById("pagination");

    let currentPage = 0;
    const size = 10;

    function fetchProducts(page) {
      fetch(`/api/products?page=${page}&size=${size}`)
      .then(response => {
        if (!response.ok) {
          throw new Error("Network response was not ok " + response.statusText);
        }
        return response.json();
      })
      .then(data => {
        tableBody.innerHTML = ""; // 기존 테이블 내용 초기화
        if (data.content) {
          data.content.forEach(product => {
            tableBody.innerHTML += `
                                <tr>
                                    <td>${product.id}</td>
                                    <td>${product.name}</td>
                                    <td>${product.price}</td>
                                    <td><img src="${product.imageUrl}" alt="image"></td>
                                    <td>
                                        <form onsubmit="
                                            event.preventDefault();
                                            window.location.href = '/products/edit/${product.id}';
                                        ">
                                            <button class="editBtn">수정</button>
                                        </form>
                                    </td>
                                    <td>
                                        <form onsubmit="
                                            event.preventDefault();
                                            deleteProduct(${product.id}, currentPage);
                                        ">
                                            <button class="removeBtn" onclick="deleteProduct(${product.id}, ${currentPage})">삭제</button>

                                        </form>
                                    </td>
                                </tr>
                            `;
          });
        }
        updatePagination(data.totalPages, page); // 페이지네이션 업데이트
      })
      .catch(error => console.error('Error:', error));
    }

    function updatePagination(totalPages, currentPage) {
      console.log('Updating pagination with total pages:', totalPages, ' and current page:', currentPage); // 디버그 로그 추가
      pagination.innerHTML = ""; // 기존 페이지네이션 내용 초기화
      for (let i = 0; i < totalPages; i++) {
        pagination.innerHTML += `
                        <button onclick="fetchProducts(${i})" class="${i === currentPage ? 'active' : ''}">${i + 1}</button>
                    `;
      }
      console.log(pagination.innerHTML); // 생성된 버튼들 확인
    }

    fetchProducts(currentPage); // 초기 데이터 요청

    window.fetchProducts = fetchProducts; // 전역 함수로 추가하여 onclick에서 접근 가능
  });
</script>
</body>
</html>
