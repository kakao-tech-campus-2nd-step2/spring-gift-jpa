<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Manage Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">
  <style>
    .inner-table th, .inner-table td {
      border-top: 1px solid #dee2e6;
      border-bottom: 1px solid #dee2e6;
      padding: 12px;
    }
    .inner-table {
      width: 100%;
      margin-bottom: 0;
    }
    .inner-table-hover tbody tr:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
<div class="container mt-3">
  <table class="table table-borderless">
    <thead class="table-primary">
    <tr>
      <th>
        <div class="d-flex justify-content-between align-items-center">
          <h2>Manage Products</h2>
          <div>
            <button class="btn btn-danger" onclick="deleteSelectedProducts()">Delete</button>
            <button class="btn btn-info" onclick="getSelectedProducts()">Update</button>
            <button class="btn btn-success" th:onclick="|location.href='@{/api/admin/addProductForm}'|">Add</button>
          </div>
        </div>
      </th>
    </tr>
    </thead>
    <tbody>
    <tr>
      <td>
        <table class="inner-table table-hover inner-table-hover">
          <thead class="table-primary">
          <tr>
            <th scope="col"></th>
            <th scope="col">id</th>
            <th scope="col">name</th>
            <th scope="col">price</th>
            <th scope="col">imageUrl</th>
          </tr>
          </thead>
          <tbody id="product-list">
          </tbody>
        </table>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    fetch('/api/products')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      const productList = document.getElementById('product-list');
      if (!data || !Array.isArray(data.productResponseDTOList)) {
        throw new Error('Invalid data format');
      }
      data.productResponseDTOList.forEach(product => {
        const row = document.createElement('tr');

        const checkboxCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'product-checkbox';
        checkbox.value = product.id;
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);

        const idCell = document.createElement('td');
        idCell.textContent = product.id;
        row.appendChild(idCell);

        const nameCell = document.createElement('td');
        nameCell.textContent = product.name;
        row.appendChild(nameCell);

        const priceCell = document.createElement('td');
        priceCell.textContent = product.price;
        row.appendChild(priceCell);

        const imageUrlCell = document.createElement('td');
        imageUrlCell.textContent = product.imageUrl;
        row.appendChild(imageUrlCell);

        productList.appendChild(row);
      });
    })
    .catch(error => console.error('Error:', error));
  });

  function deleteSelectedProducts() {
    let selectedProducts = document.querySelectorAll('.product-checkbox:checked');
    let ids = Array.from(selectedProducts).map(checkbox => checkbox.value);

    if (ids.length > 0) {
      ids.forEach(id => {
        fetch(`/api/product/${id}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (response.ok) {
            location.reload();
          } else {
            console.error('id가 잘못되었습니다.:', id);
          }
        })
        .catch(error => console.error('Error:', error));
      });
    } else {
      alert('최소 한 개 이상의 상품을 선택해주세요.');
    }
  }

  function getSelectedProducts() {
    let selectedProducts = document.querySelectorAll('.product-checkbox:checked');
    let ids = Array.from(selectedProducts).map(checkbox => checkbox.value);

    if (ids.length > 0) {
      window.location.href = `/api/admin/updateProductForm?ids=${ids.join(',')}`;
    } else {
      alert('최소 한 개 이상의 상품을 선택해주세요.');
    }
  }
</script>
</body>
</html>
