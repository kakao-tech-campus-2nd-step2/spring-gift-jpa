<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" , content="text/html; charset=UTF-8" />
    <link th:href="@{/css/user.css}" rel="stylesheet" />
    <script th:src="@{/js/main.js}" type="text/javascript"></script>
    <title>WishList Page</title>
  </head>
  <header>
    <span class="title y-middle x-start">Manager Page</span>
    <div id="buttons" class="x-end y-middle">
      <form id="show-whole-product">
        <button
          id="show-whole-product-button"
          type="button"
          class="normal-buttons"
          onclick="loadAddingPage()"
        >
          제품 전체 보기
        </button>
      </form>
    </div>
  </header>
  <body th:attr="data-userId=${userId}, data-token=${token}">
    <table id="products" class="x-middle">
      <caption class="title">
        Product List
      </caption>
      <colgroup>
        <col />
        <col />
        <col />
        <col />
        <col />
      </colgroup>
      <thead>
        <tr>
          <th>Name</th>
          <th>Price</th>
          <th>Image</th>
          <th>Quantity</th>
          <th>Control</th>
        </tr>
      </thead>
      <tbody>
        <tr
          th:id="'product'+${product.productId}"
          th:each="product : ${products}"
        >
          <td th:text="${product.name}">Name</td>
          <td th:text="${product.price}">Price</td>
          <td th:text="${product.imageUrl}">Image</td>
          <td th:text="${product.quantity}">Quantity</td>
          <td>
            <div class="buttons">
              <button
                type="button"
                class="normal-buttons small-buttons"
                th:onclick="|decreaseWishProduct(${product.productId})|"
              >
                -
              </button>
              <button
                type="button"
                class="normal-buttons small-buttons"
                th:onclick="|increaseWishProduct(${product.productId})|"
              >
                +
              </button>
              <button
                type="button"
                class="delete-buttons"
                th:onclick="|deleteWishProduct(${product.productId})|"
              >
                제품 삭제
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <script th:inline="javascript">
      async function increaseWishProduct(productId) {
        const userId = document.body.getAttribute('data-userId');
        const token = document.body.getAttribute('data-token');
        const targetUrl = `/api/users/${userId}/wishlist/products/${productId}/increase`;
        const headers = {
          'Content-Type': 'application/json',
          Authorization: token,
        };
        const body = JSON.stringify({
          userId: userId,
          productId: productId,
        });
        const method = 'put';

        const result = await requestApi(targetUrl, headers, body, method);

        if (result.response) {
          if (result.response == 'success') {
            loadCurrentPage();
          } else {
            alert(result.response);
          }
        } else {
          alert('알 수 없는 에러가 발생했습니다.');
        }
      }

      async function decreaseWishProduct(productId) {
        const userId = document.body.getAttribute('data-userId');
        const token = document.body.getAttribute('data-token');
        const targetUrl = `/api/users/${userId}/wishlist/products/${productId}/decrease`;
        const headers = {
          'Content-Type': 'application/json',
          Authorization: token,
        };
        const body = JSON.stringify({
          userId: userId,
          productId: productId,
        });
        const method = 'put';

        const result = await requestApi(targetUrl, headers, body, method);

        if (result.response) {
          if (result.response == 'success') {
            loadCurrentPage();
          } else {
            alert(result.response);
          }
        } else {
          alert('알 수 없는 에러가 발생했습니다.');
        }
      }

      async function deleteWishProduct(productId) {
        const userId = document.body.getAttribute('data-userId');
        const token = document.body.getAttribute('data-token');
        const targetUrl = `/api/users/${userId}/wishlist/products/${productId}`;
        const headers = {
          'Content-Type': 'application/json',
          Authorization: token,
        };
        const body = JSON.stringify({
          userId: userId,
          productId: productId,
        });
        const method = 'delete';

        const result = await requestApi(targetUrl, headers, body, method);

        if (result.response) {
          if (result.response == 'success') {
            loadCurrentPage();
          } else {
            alert(result.response);
          }
        } else {
          alert('알 수 없는 에러가 발생했습니다.');
        }
      }

      function loadCurrentPage() {
        const userId = document.body.getAttribute('data-userId');
        const token = document.body.getAttribute('data-token');
        const targetUrl = `/users/${userId}/main`;
        const headers = { Authorization: token };
        requestView(targetUrl, headers);
      }

      function loadAddingPage() {
        const userId = document.body.getAttribute('data-userId');
        const token = document.body.getAttribute('data-token');
        const targetUrl = `/users/${userId}/all-products`;
        const headers = { Authorization: token };
        requestView(targetUrl, headers);
      }
    </script>
  </body>
</html>
